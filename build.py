# -*- coding: utf-8 -*-
import ast

import os
import shutil
import subprocess
from pathlib import Path


def clean_build_dirs():
    for dir_name in ["dist", "build"]:
        if os.path.exists(dir_name):
            print(f"ğŸ§¹ æ¸…ç†ç›®å½•: {dir_name}")
            shutil.rmtree(dir_name)


def generate_hidden_imports():
    """ç”Ÿæˆç»„ä»¶çš„éšè—å¯¼å…¥"""
    app_dir = Path("app") / "components"
    if not app_dir.exists():
        raise FileNotFoundError("app/components ç›®å½•ä¸å­˜åœ¨")

    imports = []
    for py_file in app_dir.rglob("*.py"):
        if py_file.name in ("__init__.py", "base.py"):
            continue
        rel = py_file.relative_to(Path("."))
        mod = str(rel).replace(os.sep, '.')[:-3]
        imports.append(f"--hidden-import={mod}")
    return imports


def build():
    # ğŸ‘‡ å…ˆç”Ÿæˆé¢„å¯¼å…¥è„šæœ¬
    cmd = [
        "pyinstaller",
        "--onedir",
        "--windowed",
        "-y",
        "--add-data", "app;app",
        "--add-data", "icons;icons",
    ]

    cmd.append("main.py")

    print("ğŸ“¦ æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼š")
    print(" ".join(cmd))

    result = subprocess.run(cmd)
    if result.returncode == 0:
        print("âœ… æ‰“åŒ…å®Œæˆï¼")
    else:
        print("âŒ æ‰“åŒ…å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯")


def extract_imports_from_file(file_path):
    """ä» Python æ–‡ä»¶ä¸­æå–æ‰€æœ‰é¡¶å±‚ import è¯­å¥"""
    imports = set()
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            tree = ast.parse(f.read())

        for node in ast.walk(tree):
            # å¤„ç† import xxx
            if isinstance(node, ast.Import):
                for alias in node.names:
                    imports.add(alias.name.split('.')[0])
            # å¤„ç† from xxx import yyy
            elif isinstance(node, ast.ImportFrom):
                if node.module:
                    imports.add(node.module.split('.')[0])
    except Exception as e:
        print(f"âš ï¸ æ— æ³•è§£æ {file_path}: {e}")

    return imports


def generate_preimport_script():
    """æ‰«ææ‰€æœ‰ç»„ä»¶æ–‡ä»¶ï¼Œç”Ÿæˆé¢„å¯¼å…¥è„šæœ¬"""
    components_dir = Path("app") / "components"
    if not components_dir.exists():
        print("âŒ app/components ç›®å½•ä¸å­˜åœ¨")
        return None

    all_imports = set()

    # æ‰«ææ‰€æœ‰ .py æ–‡ä»¶
    for py_file in components_dir.rglob("*.py"):
        if py_file.name in ("__init__.py", "base.py"):
            continue
        imports = extract_imports_from_file(py_file)
        all_imports.update(imports)

    # è¿‡æ»¤æ‰æ ‡å‡†åº“å’Œæœ¬åœ°æ¨¡å—
    # ä¿ç•™å¯èƒ½éœ€è¦ PyInstaller ç‰¹æ®Šå¤„ç†çš„ç¬¬ä¸‰æ–¹åº“
    third_party_libs = {
        'pandas', 'numpy', 'scipy', 'matplotlib', 'seaborn', 'sklearn',
        'torch', 'tensorflow', 'cv2', 'PIL', 'requests', 'yaml', 'json',
        'openpyxl', 'xlrd', 'xlwt', 'sqlalchemy', 'psycopg2', 'mysql',
        'pyodbc', 'pymongo', 'redis', 'kafka', 'boto3', 'azure', 'google',
        'plotly', 'bokeh', 'dash', 'streamlit', 'fastapi', 'flask',
        'django', 'celery', 'apscheduler', 'schedule', 'loguru'
    }

    # åªä¿ç•™ç¬¬ä¸‰æ–¹åº“ï¼ˆå¯ä»¥æ ¹æ®ä½ çš„é¡¹ç›®è°ƒæ•´è¿™ä¸ªåˆ—è¡¨ï¼‰
    pre_imports = all_imports & third_party_libs

    # ä¹Ÿå¯ä»¥é€‰æ‹©ä¸è¿‡æ»¤ï¼Œç›´æ¥å¯¼å…¥æ‰€æœ‰ï¼ˆä½†å¯èƒ½åŒ…å«æ— æ•ˆæ¨¡å—ï¼‰
    # pre_imports = all_imports

    if not pre_imports:
        print("âš ï¸ æ²¡æœ‰å‘ç°éœ€è¦é¢„å¯¼å…¥çš„ç¬¬ä¸‰æ–¹åº“")
        return None

    # ç”Ÿæˆé¢„å¯¼å…¥ä»£ç 
    preimport_code = "# Auto-generated pre-imports for PyInstaller compatibility\n"
    preimport_code += "# DO NOT EDIT - generated by gen_preimports.py\n\n"

    for lib in sorted(pre_imports):
        preimport_code += f"try:\n    import {lib}\nexcept ImportError:\n    pass  # Optional dependency\n"

    return preimport_code


def save_preimport_script():
    """ä¿å­˜é¢„å¯¼å…¥è„šæœ¬åˆ° pre_imports.py"""
    code = generate_preimport_script()
    if code:
        with open("pre_imports.py", "w", encoding="utf-8") as f:
            f.write(code)
        print("âœ… ç”Ÿæˆ pre_imports.py æˆåŠŸ")
        print("ç”Ÿæˆçš„å¯¼å…¥æ¨¡å—:", sorted(
            [line.split()[-1] for line in code.split('\n') if 'import' in line and not line.strip().startswith('#')]))
    else:
        # åˆ›å»ºç©ºæ–‡ä»¶é¿å…å¯¼å…¥é”™è¯¯
        with open("pre_imports.py", "w", encoding="utf-8") as f:
            f.write("# No pre-imports needed\n")
        print("âœ… åˆ›å»ºç©ºçš„ pre_imports.py")


if __name__ == "__main__":
    save_preimport_script()
    build()